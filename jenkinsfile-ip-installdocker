pipeline {
  agent any

  environment {
    SSH_USER     = "boho"                          // SSH user ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö Ansible VM ‡πÅ‡∏•‡∏∞ target VM
    ANSIBLE_HOST = "4.145.84.26"                   // IP ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô Ansible (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà VM ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢)
    PROJECT_DIR  = "ansible-ssh-test"
    GIT_BRANCH   = "dev"
    GIT_REPO     = "https://github.com/kitsanaphon1/ansible-ssh-test.git"
  }

  stages {
    stage('üì• Checkout Project on Ansible VM') {
      steps {
        sshagent(['ssh-ansible-agent']) {
          sh """
            ssh -o StrictHostKeyChecking=no ${SSH_USER}@${ANSIBLE_HOST} <<EOF
              if [ ! -d "${PROJECT_DIR}" ]; then
                git clone ${GIT_REPO}
              fi
              cd ${PROJECT_DIR}
              git fetch origin
              git checkout -B ${GIT_BRANCH} origin/${GIT_BRANCH}
              git pull origin ${GIT_BRANCH}
EOF
          """
        }
      }
    }

    stage('üì° Get Public IP') {
      steps {
        sshagent(['ssh-ansible-agent']) {
          sh """
            echo "üì° ‡∏î‡∏∂‡∏á Public IP ‡∏à‡∏≤‡∏Å Azure"
            ssh -o StrictHostKeyChecking=no ${SSH_USER}@${ANSIBLE_HOST} \\
              'cd ${PROJECT_DIR}/playbooks && \\
               source ~/ansible-env/bin/activate && \\
               ansible-playbook get-ip.yaml -e "@../config/config-dev.yaml"'
          """
        }
      }
    }

    stage('üìñ Read IP from ip.txt') {
      steps {
        script {
          def ip = sh(
            script: "ssh -o StrictHostKeyChecking=no ${SSH_USER}@${ANSIBLE_HOST} 'cat ~/ip.txt'",
            returnStdout: true
          ).trim()
          echo "üìç IP ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Azure ‡∏Ñ‡∏∑‡∏≠: ${ip}"
          env.TARGET_VM_IP = ip
        }
      }
    }

    stage('üê≥ Install Docker and Docker Compose') {
      steps {
        sshagent(['ssh-ansible-agent']) {
          sh """
            echo "üê≥ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Docker ‡∏ö‡∏ô VM ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ${env.TARGET_VM_IP}"
            ssh -o StrictHostKeyChecking=no ${SSH_USER}@${ANSIBLE_HOST} \\
              'cd ${PROJECT_DIR}/playbooks && \\
               source ~/ansible-env/bin/activate && \\
               ANSIBLE_HOST_KEY_CHECKING=False \\
               ansible-playbook install-docker.yaml -i ${env.TARGET_VM_IP}, --user=${SSH_USER}'
          """
        }
      }
    }
  }
}
